app.loader=function(){var o={_events:{},on:function(t,e){this._events[t]||(this._events[t]=[]),this._events[t].push(e)},off:function(t,e){if(this._events[t]){var s=this._events[t].indexOf(e);-1<s&&this._events[t].splice(s,1)}},trigger:function(t){if(this._events[t]){var e=0,s=this._events[t].length;if(s)for(;e<s;e++)this._events[t][e].apply(this,[].slice.call(arguments,1))}}};function a(t,e,s){this.imgs=t,this.id=e,this.each=s&&s.each||null,this.all=s&&s.all||null,this.onProcessChange=s&&s.onProcessChange||function(){},this.isFinish=!1,this._paused=!1,this._numItems=0,this._numLoadings=0,this._numItemsLoaded=0,this._loadedPercent=0,this._maxConnections=3,this._loadQueueBackup=[],this._loadQueue=[],this._loadedQueue=[],this._loadingQueue=[],this._loadfiles()}function t(){this.manifest=null,this.onEachFrontImgLoaded=null,this.onAllFrontImgLoaded=null,this.onFrontProcessChange=null,this.showPageNo=0,this.isAllTaskDone=!1,this.currentTask=null,this._rawTaskQueue=[],this._doneTaskQueue=[],this._waitingTaskQueue=[]}return a.prototype={load:function(){this._paused=!1,this._loadNext()},pause:function(t){for(var e=0;e<this._loadingQueue.length;e++){var s=this._loadingQueue[e];s.setAttribute("data-loaded","unload"),s.onload=null,s.onerror=null,s.src="",this._loadQueue.push(s)}this._numLoadings=0,this._loadingQueue=[],this._paused=!0},reset:function(t){this.imgs=t,this.isFinish=!1,this._paused=!1,this._numItems=0,this._numLoadings=0,this._numItemsLoaded=0,this._loadedPercent=0,this._loadQueueBackup=[],this._loadQueue=[],this._loadedQueue=[],this._loadingQueue=[],this._loadfiles()},_loadfiles:function(){this._loadQueue=[],this._loadQueueBackup=[],this._loadQueueBackup=[],this._numItems=this.imgs.length;for(var t=0;t<this.imgs.length;t++){var e=this.imgs[t].getAttribute("data-src");e||(e=this.imgs[t].src,this.imgs[t]=new Image),this.imgs[t].url=e,this.imgs[t].setAttribute("data-loaded","unload"),this.imgs[t].percent=0,this._loadQueue.push(this.imgs[t]),this._loadQueueBackup.push(this.imgs[t])}},_loadNext:function(){if(0===this._numItems){var t=this;return this.isFinish=!0,this._paused=!0,o.trigger("taskFinished",[t.id]),void(t.all&&t.all.call(app.loader))}if(!this._paused)for(var e=0;e<this._loadQueue.length&&!(this._numLoadings>=this._maxConnections);e++){var s=this._loadQueue[e];s.setAttribute("data-loaded","loading"),this._loadingQueue.push(s),this._numLoadings++,this._loadQueue.splice(e,1),e--,this._loadImg(s)}},_loadImg:function(t){var e=this;t.setAttribute("data-loaded","loading"),t.src=t.url,t.complete?(t.setAttribute("data-loaded","loaded"),e._onImgLoaded(t)):(t.onload=function(){t.setAttribute("data-loaded","loaded"),e._onImgLoaded(t),t.onload=null},t.onerror=function(){t.setAttribute("data-loaded","error"),e._onImgLoaded(t),t.onerror=null})},_onImgLoaded:function(t){this._numLoadings--,this._numItemsLoaded++,function(t,e){for(var s=0;s<t.length;s++)t[s]==e&&(t[s]=t[t.length-1],t.pop())}(this._loadingQueue,t),this._loadedQueue.push(t);var e=this;this.onProcessChange instanceof Function&&(e._loadedPercent=this._numItemsLoaded/this._numItems,e.onProcessChange&&e.onProcessChange.call(t,{img:t,src:t.src,index:this._numItemsLoaded,percent:e._loadedPercent})),this._numItemsLoaded>=this._numItems&&(e.isFinish=!0,e._paused=!0,o.trigger("taskFinished",[e.id]),e.all&&this.all()),this._loadNext()}},t.prototype={init:function(t){this.manifest=t.manifest,this.firstTaskId=t.firstTaskId,this.onEachFrontImgLoaded=t.onEachFrontImgLoaded,this.onFrontProcessChange=t.onFrontProcessChange,this.onAllFrontImgLoaded=t.onAllFrontImgLoaded;for(var e=this,s=e.manifest,i=0,a=s.length;i<a;i++){var n=e.getImgs(s[i]);e.addTask(n,s[i].id,s[i])}o.on("taskFinished",function(t){e.currentTask=e.getNextTask(),-1==e.currentTask?(e.allTaskDoneCallback(),e.isAllTaskDone=!0):e.currentTask.load()})},getImgs:function(t){for(var e=this._getImgArray(t.selector),s=[],i=0;t.imgs&&i<t.imgs.length;i++){var a=new Image;a.setAttribute("data-src",t.imgs[i]),s.push(a)}return Array.prototype.push.apply(s,e),s},start:function(t){this.currentTask=this.getNextTask(t),this.currentTask.onProcessChange=this.onFrontProcessChange,this.currentTask.all=this.onAllFrontImgLoaded,this.currentTask.load()},addTask:function(t,e,s){var i=new a(t,e,s);this._rawTaskQueue.push(i)},allTaskDoneCallback:function(){},isTaskDone:function(t){for(var e=0,s=this._rawTaskQueue.length;e<s;e++)if(this._rawTaskQueue[e].id==t)return this._rawTaskQueue[e].isFinish;return-1},getNextTask:function(t){var e=this,s=0,i=e._rawTaskQueue.length;if(null!=t&&""!==t)for(s=0;s<i;s++)if(e._rawTaskQueue[s].id==t)return e._rawTaskQueue[s];for(s=0;s<i;s++)if(!0!==e._rawTaskQueue[s].isFinish)return e._rawTaskQueue[s];if(s==i)return-1},resetTask:function(t,e){var s=this,i=s.getImgs(e);s.getNextTask(t).reset(i),s.currentTask=s.getNextTask(t),s.currentTask.load()},_getImgArray:function(){for(var t=[],e=[],s=0;s<=arguments.length;s++)e=Array.prototype.slice.call(document.querySelectorAll(arguments[s])),Array.prototype.push.apply(t,e);return t}},new t}();